# Generated by ansible
# This iptables restore file is used to configure the host to
# work with OpenVPN on this host

*nat
:PREROUTING {{ openvpn_server_iptables_nat_prerouting | upper }} [0:0]
:INPUT {{ openvpn_server_iptables_nat_input | upper }} [0:0]
:OUTPUT {{ openvpn_server_iptables_nat_output | upper }} [0:0]
:POSTROUTING {{ openvpn_server_iptables_nat_postrouting | upper }} [0:0]

# This rule is necessary for OpenVPN to work and forward IP packets
{% for instance in openvpn_server_instances %}
-A POSTROUTING -s {{ instance.cidr }} -o {{ ansible_default_ipv4.interface }} -j MASQUERADE
{% endfor %}
COMMIT

*filter
:INPUT {{ openvpn_server_iptables_filter_input | upper }} [0:0]
:FORWARD {{ openvpn_server_iptables_filter_forward | upper }} [0:0]
:OUTPUT {{ openvpn_server_iptables_filter_output | upper }} [0:0]

# Allow connections to the VPN
{% for instance in openvpn_server_instances %}
-A INPUT -p {{ instance.proto }} --dport {{ instance.port }} -j ACCEPT
{% endfor %}
{% for instance in openvpn_server_instances %}
-A FORWARD -s {{ instance.cidr }} -j ACCEPT
{% endfor %}

# Allow SSH connections on the VPN
{% for instance in openvpn_server_instances %}
-A INPUT -p tcp -d {{ instance.cidr }} --dport {{ ansible_port | default('22') }} -j ACCEPT
{% endfor %}
COMMIT